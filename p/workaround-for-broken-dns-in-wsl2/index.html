<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="WSL2 uses the Windows host&rsquo;s DNS - so if DNS is working on Windows, normally WSL2 should be fine as well! Unfortunately, DNS in WSL2 just randomly stopped working for me at some point. The /etc/resolv.conf file generated by WSL2 was still being correctly created but DNS just wouldn&rsquo;t work.
Luckily there are plenty of ways to work around this, because we can just do DNS ourselves inside the Linux running in WSL2.
"><meta name=author content="Valentin Heidelberger"><link rel=canonical href=https://valh.io/p/workaround-for-broken-dns-in-wsl2/><link rel=icon type=image/x-icon href=/img/favicon.ico><title>Workaround for broken DNS in WSL2</title><link rel=stylesheet href=/css/styles.css><link rel=stylesheet href=/css/syntax.css><link id=custom_css href=/css/custom.css rel=stylesheet><link id=dark_css href=/css/dark.css rel=stylesheet><link href=/css/webfonts/fontawesome.min.css rel=stylesheet><link href=/css/webfonts/brands.min.css rel=stylesheet><link href=/css/webfonts/solid.min.css rel=stylesheet><link href=/css/webfonts/regular.min.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light" id=mainNav><div class="container px-4 px-lg-5"><a class=navbar-brand href=/index.html><picture><source srcset=/img/logo_small_dark.webp media="(max-width: 991px) and (prefers-color-scheme: light)"><source srcset=/img/logo_small.webp media="(max-width: 991px) and (prefers-color-scheme: dark)"><source srcset=/img/logo_small.webp media="(min-width: 992px)"><img class=navbar-logo>
</picture>Valentin Heidelberger
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarResponsive aria-controls=navbarResponsive aria-expanded=false aria-label="Toggle navigation">
Menu
<i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ms-auto py-4 py-lg-0"><li class=nav-item><a class="nav-link px-lg-3 py-3 py-lg-4 active" title=Blog href=/index.html><span class="fa fa-book-open"></span>
<span>Blog</span></a></li><li class=nav-item><a href=/search/ class="nav-link px-lg-3 py-3 py-lg-4" title=Search><span class="fa fa-search nav-search-icon"></span>
<span>Search</span></a></li><li class=nav-item><a class="nav-link px-lg-3 py-3 py-lg-4" title="About me" href=/about-me><span class="fas fa-user"></span>
<span>About me</span></a></li></ul></div></div></nav><header class=masthead style=background-image:url(/img/tags/linux.webp)><div class="container position-relative px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><div class=post-heading><h1>Workaround for broken DNS in WSL2</h1><h2 class=subheading></h2><span class=meta>Posted on April 29, 2022</span>
<span class=meta>Tags:
<a href=/tags/linux>#linux
</a><a href=/tags/wsl>#wsl
</a><a href=/tags/windows>#windows
</a><a href=/tags/technology>#technology</a></span></div></div></div></div></header><article class=mb4><aside id=custom_toc><nav id=TableOfContents><ul><li><a href=#prerequisite-deactivate-auto-generation-of-etcresolvconf>Prerequisite: Deactivate auto-generation of <code>/etc/resolv.conf</code></a></li><li><a href=#one-remote-dns-server>One remote DNS server</a></li><li><a href=#multiple-remote-dns-servers>Multiple remote DNS servers</a><ul><li><a href=#install-dns-server-software-dnsmasq>Install dns server software <strong>dnsmasq</strong></a></li><li><a href=#configure-dnsmasq>Configure dnsmasq</a></li><li><a href=#get-dnsmasq-ip-address>Get dnsmasq ip address</a></li><li><a href=#set-dnsmasq-as-dns-server-to-be-used>Set dnsmasq as DNS server to be used</a></li><li><a href=#start-dnsmasq-automatically-at-wsl-start-hacky>Start dnsmasq automatically at WSL start (hacky)</a></li></ul></li></ul></nav></aside><div class="container px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><p>WSL2 uses the Windows host&rsquo;s DNS - so if DNS is working on Windows, normally WSL2 should be fine as well! Unfortunately, DNS in WSL2 just randomly stopped working for me at some point. The <code>/etc/resolv.conf</code> file generated by WSL2 was still being correctly created but DNS just wouldn&rsquo;t work.</p><p>Luckily there are plenty of ways to work around this, because we can just do DNS ourselves inside the Linux running in WSL2.</p><h1 id=prerequisite-deactivate-auto-generation-of-etcresolvconf>Prerequisite: Deactivate auto-generation of <code>/etc/resolv.conf</code></h1><p>For any of the following scenarios we need to stop WSL2 from writing to <code>/etc/resolv.conf</code> first, because we need to persistently modify it.</p><p>In WSL2, open a file <code>/etc/wsl.conf</code>, paste the following content and save:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>network<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>generateResolvConf</span> <span class=o>=</span> <span class=nb>false</span>
</span></span></code></pre></div><p>If you also want to stop WSL2 from overwriting your <code>/etc/hosts.conf</code>, you need to add another line like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>generateHosts</span> <span class=o>=</span> <span class=nb>false</span>
</span></span></code></pre></div><p>To have these changes take effect, you need to restart WSL2. Close your WSL2 window, start PowerShell as admin and run the following command to shutdown WSL2.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>wsl</span><span class=p>.</span><span class=py>exe</span> <span class=p>-</span><span class=n>-shutdown</span>
</span></span></code></pre></div><p><a href=https://github.com/microsoft/WSL/issues/5611#issuecomment-661272808>See here</a> for reference, if you want to know in detail why this is necessary.</p><p>After the command has finished successfully, you can start WSL2 again.</p><p>Back in WSL, remove the broken DNS configuration file that WSL leaves behind.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm /etc/resolv.conf
</span></span></code></pre></div><p>Next, we&rsquo;ll set up DNS inside Linux. There are multiple ways of varying complexity depending on your use case.</p><h1 id=one-remote-dns-server>One remote DNS server</h1><p>If you just need to use one DNS server like a public DNS or a server provided by your organization that can resolve everything you need, this is the most simple setup.</p><p>In WSL2, open the file <code>/etc/resolv.conf</code>, paste the following content and save:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nameserver  &lt;your dns server&gt;
</span></span></code></pre></div><p>If you wanted to use CloudFlare&rsquo;s public DNS for example, it&rsquo;d look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nameserver  1.1.1.1
</span></span></code></pre></div><h1 id=multiple-remote-dns-servers>Multiple remote DNS servers</h1><p>If you need to use multiple DNS servers, you&rsquo;ll have to setup your own DNS server, which in turn uses the remote DNS servers you need. Don&rsquo;t worry, it&rsquo;s easy!</p><p>For example, in my WSL2 Ubuntu environment I need to use a specific DNS server for an internal domain and a public DNS for everything else.</p><h2 id=install-dns-server-software-dnsmasq>Install dns server software <strong>dnsmasq</strong></h2><p>Firstly, install the dns server <strong>dnsmasq</strong>. You might need to use a different package manager depending on your Linux distro. This works on Ubuntu and other Debian-based distros:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt install -y dnsmasq
</span></span></code></pre></div><h2 id=configure-dnsmasq>Configure dnsmasq</h2><p>After dnsmasq has been installed, open it&rsquo;s config file <code>/etc/dnsmasq.conf</code>, add the following and save.</p><p>dnsmasq comes with a big config file full of deactivated settings as reference. If you want to keep all that, that&rsquo;s no problem - I did it as well and just appended the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>server</span><span class=o>=</span>/&lt;your internal domain&gt;/&lt;your internal DNS server&gt;
</span></span><span class=line><span class=cl><span class=nv>server</span><span class=o>=</span>&lt;your external DNS server&gt;
</span></span><span class=line><span class=cl>no-dhcp-interface<span class=o>=</span>
</span></span></code></pre></div><p><code>&lt;your internal DNS server></code> will only be used for domains under <code>&lt;your internal domain></code>. You can add as many of these as you want, if you have multiple internal domains for example.</p><p><code>&lt;your external DNS server></code> is the public DNS server and will be used for everything else.</p><p><code>no-dhcp-interface=</code> deactives the DHCP and TFTP capabilities of dnsmasq, because we only want it to provide DNS.</p><p>So if I have an internal domain called <code>mycompany.internal</code>, an internal DNS server <code>192.168.1.53</code> and the public CloudFlare DNS <code>1.1.1.1</code>, it&rsquo;d look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>server</span><span class=o>=</span>/mycompany.internal/192.168.1.53
</span></span><span class=line><span class=cl><span class=nv>server</span><span class=o>=</span>1.1.1.1
</span></span><span class=line><span class=cl>no-dhcp-interface<span class=o>=</span>
</span></span></code></pre></div><p>Finally, start dnsmasq&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo service dnsmasq start
</span></span></code></pre></div><p>&mldr;and check whether it started successfully.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo service dnsmasq status
</span></span></code></pre></div><h2 id=get-dnsmasq-ip-address>Get dnsmasq ip address</h2><p>Now that we have installed, configured and started dnsmasq, we need to configure our Linux to use it as for DNS. We need to find the IP address that dnsmasq is listening on first.</p><p>This can be accomplished with <code>netstat</code>, which you can install with the package <code>net-tools</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install -y net-tools
</span></span></code></pre></div><p>This command gives us the IPs that any running instances of dnsmasq are listening on:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo netstat -tulpen <span class=p>|</span> grep dnsmasq
</span></span></code></pre></div><p>If there is not output, make sure dnsmasq is up and running. If its not running, check for errors in the config file.</p><h2 id=set-dnsmasq-as-dns-server-to-be-used>Set dnsmasq as DNS server to be used</h2><p>Open <code>/etc/resolv.conf</code> and add the IP you&rsquo;ve just found. In my case it was <code>127.0.0.53</code> but it can also be <code>0.0.0.0</code>.</p><p>If it is <code>0.0.0.0</code> just put <code>127.0.0.1</code> as IP here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nameserver  127.0.0.53
</span></span></code></pre></div><p>Save the file to start using dnsmasq as DNS server.</p><h2 id=start-dnsmasq-automatically-at-wsl-start-hacky>Start dnsmasq automatically at WSL start (hacky)</h2><p>Since WSL2 is not a real Linux, we can&rsquo;t use systemd or similar <em>good ways</em> to automatically start our newly configured DNS server <em>for now</em> (systemd is supposed to be added to Ubuntu WSL in the future).</p><p>I didn&rsquo;t dig for a perfect solution here tbh, because I&rsquo;m using Windows and WSL2 involuntarily.</p><p>That&rsquo;s why I just wrote a tiny Shell script which checks whether dnsmasq is running and, if it doesn&rsquo;t, starts it. This runs every time I open a shell in WSL2.</p><p>It&rsquo;s not pretty and in a real Linux environment I&rsquo;d never do it this way but for this specific use-case it&rsquo;s totally fine imho.</p><p>Open your <code>~/.bashrc</code> and <strong>append</strong> the following at the end of the file. If you&rsquo;re using a different shell, such as <strong>ZSH</strong>, use the corresponding rc file like <code>~/.zshrc</code> instead of <code>~/.bashrc</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>service dnsmasq status &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>3</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=nb>echo</span> <span class=s2>&#34;Dnsmasq not running, please provide sudo pw to start it...&#34;</span><span class=p>;</span> sudo service dnsmasq start<span class=p>;</span> <span class=k>fi</span>
</span></span></code></pre></div><p>Next time you start a shell, you&rsquo;ll be prompted to enter your password to start dnsmasq, if it&rsquo;s not yet running.</p><br></div></div></div></article><footer class=border-top><div class="container px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><ul class="list-inline text-center"><li class=list-inline-item><a href=/index.xml target=_blank><i style=margin:.25em class="fa fa-rss fa-2xl"></i></a></li><li class=list-inline-item><a href=https://github.com/va1entin target=_blank><i style=margin:.25em class="fab fa-github fa-2xl"></i></a></li><li class=list-inline-item><a href=https://gitlab.com/va1entin target=_blank><i style=margin:.25em class="fab fa-gitlab fa-2xl"></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/in/va1entin target=_blank><i style=margin:.25em class="fab fa-linkedin fa-2xl"></i></a></li><div class="small text-center text-muted fst-italic"><br><br><a rel=license href=http://creativecommons.org/licenses/by/4.0/ target=_blank>CC-BY 4.0 International</a> Valentin Heidelberger 2017 - 2024<br>This applies to the contents of my blog and other texts on this site only.<br><a href=/terms-of-use>Terms of use</a></div></ul><br><br></div></div></div></footer><script src=/js/bootstrap.bundle.min.js></script><script src=/js/scripts.js></script></body></html>