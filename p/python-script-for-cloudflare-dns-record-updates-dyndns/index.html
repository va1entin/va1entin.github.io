<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Note: This is an update to a post from 2019 and features a rewrite in Python with various new features including IPv6 support, logging, argument parser, &mldr;
Why I&rsquo;m using Cloudflare as CDN and DNS provider as well as domain registrar. For a system with an external IPv4 address that changes daily I needed a way to dynamically update a DNS record at Cloudflare with the system&rsquo;s current external IP address.
"><meta name=author content="Valentin Heidelberger"><link rel=canonical href=https://valh.io/p/python-script-for-cloudflare-dns-record-updates-dyndns/><link rel=icon type=image/x-icon href=/img/favicon.ico><title>Python script for Cloudflare DNS record updates (DynDNS)</title><link rel=stylesheet href=/css/styles.css><link rel=stylesheet href=/css/syntax.css><link id=custom_css href=/css/custom.css rel=stylesheet><link id=dark_css href=/css/dark.css rel=stylesheet><link href=/css/webfonts/fontawesome.min.css rel=stylesheet><link href=/css/webfonts/brands.min.css rel=stylesheet><link href=/css/webfonts/solid.min.css rel=stylesheet><link href=/css/webfonts/regular.min.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light" id=mainNav><div class="container px-4 px-lg-5"><a class=navbar-brand href=/index.html><picture><source srcset=/img/logo_small_dark.webp media="(max-width: 991px) and (prefers-color-scheme: light)"><source srcset=/img/logo_small.webp media="(max-width: 991px) and (prefers-color-scheme: dark)"><source srcset=/img/logo_small.webp media="(min-width: 992px)"><img class=navbar-logo>
</picture>Valentin Heidelberger
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarResponsive aria-controls=navbarResponsive aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ms-auto py-4 py-lg-0"><li class=nav-item><a class="nav-link px-lg-3 py-3 py-lg-4 active" title=Blog href=/index.html><span class="fa fa-book-open"></span>
<span>Blog</span></a></li><li class=nav-item><a href=/search/ class="nav-link px-lg-3 py-3 py-lg-4" title=Search><span class="fa fa-search nav-search-icon"></span>
<span>Search</span></a></li><li class=nav-item><a class="nav-link px-lg-3 py-3 py-lg-4" title="About me" href=/about-me><span class="fas fa-user"></span>
<span>About me</span></a></li></ul></div></div></nav><header class=masthead style=background-image:url(/img/dall_e_1.webp)><div class="container position-relative px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><div class=post-heading><h1>Python script for Cloudflare DNS record updates (DynDNS)</h1><h2 class=subheading>No global API key required</h2><span class=meta>Posted on February 06, 2021</span>
<span class=meta>Note that this post is older than 3 years and might contain out-of-date information.</span>
<span class=meta>Tags:
<a href=/tags/raspberrypi>#raspberrypi
</a><a href=/tags/technology>#technology
</a><a href=/tags/linux>#linux</a></span></div></div></div></div></header><article class=mb4><aside id=custom_toc><nav id=TableOfContents><ul><li><a href=#why>Why</a></li><li><a href=#how>How</a><ul><li><a href=#getting-the-script>Getting the script</a></li><li><a href=#setting-up-api-tokens>Setting up API tokens</a><ul><li><a href=#edit-token>Edit token</a></li><li><a href=#read-token>Read token</a></li></ul></li><li><a href=#create-config-file>Create config file</a></li><li><a href=#run-script>Run script</a><ul><li><a href=#logging>Logging</a></li><li><a href=#ip-provider>IP provider</a></li></ul></li><li><a href=#update-a-dns-a-ipv4-record>Update a DNS A (IPv4) record</a></li><li><a href=#update-a-dns-aaaa-ipv6-record>Update a DNS AAAA (IPv6) record</a></li></ul></li></ul></nav></aside><div class="container px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><p><strong>Note:</strong> This is an update to a post from 2019 and features a rewrite in Python with various new features including IPv6 support, logging, argument parser, &mldr;</p><h1 id=why>Why</h1><p>I&rsquo;m using Cloudflare as CDN and DNS provider as well as domain registrar. For a system with an external IPv4 address that changes daily I needed a way to dynamically update a DNS record at Cloudflare with the system&rsquo;s current external IP address.</p><p>There are numerous ways to do DynDNS but I wanted to get into Cloudflare&rsquo;s API anyway and it turns out that this is, at least in my opinion, much easier to set up than some generic DynDNS package.</p><h1 id=how>How</h1><h2 id=getting-the-script>Getting the script</h2><p>I&rsquo;ve written a Python script, based on a bash script by <a href=https://gist.github.com/benkulbertis/fff10759c2391b6618dd>benkulbertis</a>.</p><p>The Python script does <em>not</em> require a general API token. So you can set up API tokens specifically authorized for what the script needs to do.</p><p>You can get the script <a href=https://github.com/va1entin/tools/blob/master/cloudflare_update_record/cloudflare_update_record.py>here</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://raw.githubusercontent.com/va1entin/tools/master/cloudflare_update_record/cloudflare_update_record.py
</span></span></code></pre></div><h2 id=setting-up-api-tokens>Setting up API tokens</h2><p>The script needs two tokens:</p><ul><li>one to read DNS records and settings</li><li>one to actually edit a DNS zone</li></ul><p>To set the tokens up, log in to your Cloudflare account and go to <a href=https://dash.cloudflare.com/profile/api-tokens>this page</a>.</p><p><strong>Note</strong>, that you can also limit the tokens to a specific domain! This is of course important to know if you have multiple domains in your Cloudflare account and the script shall only read/edit the settings of one of these.</p><h3 id=edit-token>Edit token</h3><p>On the <a href=https://dash.cloudflare.com/profile/api-tokens>API token page</a>, click <strong>Create Token</strong> and use the template <strong>Edit zone DNS</strong>.</p><p>Alternatively, click <strong>Get started</strong> next to <strong>Create Custom Token</strong> and configure the token as follows:</p><table class="table table-striped table-bordered"><thead><tr><th>Type</th><th>Resource</th><th>Permission</th></tr></thead><tbody><tr><td>Zone</td><td>DNS</td><td>Edit</td></tr></tbody></table><p>Click <a href=/img/posts/cloudflare_edit_token.webp>here</a> for a screenshot.</p><h3 id=read-token>Read token</h3><p>On the <a href=https://dash.cloudflare.com/profile/api-tokens>API token page</a>, click <strong>Create Token</strong> and click <strong>Get started</strong> next to <strong>Create Custom Token</strong>.</p><table class="table table-striped table-bordered"><thead><tr><th>Type</th><th>Resource</th><th>Permission</th></tr></thead><tbody><tr><td>Zone</td><td>DNS</td><td>Read</td></tr></tbody></table><p>Click <a href=/img/posts/cloudflare_read_token.webp>here</a> for a screenshot.</p><h2 id=create-config-file>Create config file</h2><p>The script uses a YAML-format config file and assumes it at <code>./cloudflare_update_record_config.yaml</code>. You can give a different path using the <code>-c | --config</code> parameter.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>read_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;YOUR READ TOKEN&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>edit_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;YOUR EDIT TOKEN&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>zone_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;YOUR ZONE NAME&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>record_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;YOUR RECORD NAME&gt;&#34;</span><span class=w>
</span></span></span></code></pre></div><p>So if I wanted to change a DNS record called <em>hello.example.com</em> using a read token <em>foo</em> and an edit token <em>bar</em>, the config would look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>read_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;foo&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>edit_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>zone_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>record_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hello&#34;</span><span class=w>
</span></span></span></code></pre></div><p>To change the root record of your domain - <em>example.com</em> itself - use @ as record_name, just like in the Cloudflare dashboard:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>read_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;foo&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>edit_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>zone_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>record_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;@&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 id=run-script>Run script</h2><p>Lastly run the script with your desired parameters. I recommend reading the brief usage info at least once:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./cloudflare_update_record.py -h
</span></span></code></pre></div><h3 id=logging>Logging</h3><p>The scripts logs to <code>cloudflare_update_record.log</code> with log level <code>info</code> by default. You can change the log file and log level, see <code>-h</code>.</p><h3 id=ip-provider>IP provider</h3><p>It gets the external IP address from a <em>provider</em>, by default: <a href=https://icanhazip.com>icanhazip.com</a></p><p>You can specify a different provider, see <code>-h</code>.
The provider must return <strong>just the IP address as plain text</strong> on a <code>HTTP GET</code> request - no additional HTML or anything else. Assuming an external IPv4 address <code>1.1.1.1</code>, it should look like this, when tested with curl:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># curl https://ipv4.icanhazip.com</span>
</span></span><span class=line><span class=cl>1.1.1.1
</span></span></code></pre></div><h2 id=update-a-dns-a-ipv4-record>Update a DNS A (IPv4) record</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cloudflare_update_record.py -4
</span></span></code></pre></div><h2 id=update-a-dns-aaaa-ipv6-record>Update a DNS AAAA (IPv6) record</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cloudflare_update_record.py -6
</span></span></code></pre></div><p>Check the log for a message <code>INFO: DNS A record update succeeded, IP changed to: &lt;YOUR IP ADDRESS></code>
and remember that it might take up to 24 hours for your DNS update to be propagated around the world.</p><br></div></div></div></article><footer class=border-top><div class="container px-4 px-lg-5"><div class="row gx-4 gx-lg-5 justify-content-center"><div class="col-md-10 col-lg-8 col-xl-7"><ul class="list-inline text-center"><li class=list-inline-item><a href=/index.xml target=_blank><i style=margin:.25em class="fa fa-rss fa-2xl"></i></a></li><li class=list-inline-item><a href=https://github.com/va1entin target=_blank><i style=margin:.25em class="fab fa-github fa-2xl"></i></a></li><li class=list-inline-item><a href=https://gitlab.com/va1entin target=_blank><i style=margin:.25em class="fab fa-gitlab fa-2xl"></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/in/va1entin target=_blank><i style=margin:.25em class="fab fa-linkedin fa-2xl"></i></a></li><div class="small text-center text-muted fst-italic"><br><br><a rel=license href=http://creativecommons.org/licenses/by/4.0/ target=_blank>CC-BY 4.0 International</a> Valentin Heidelberger 2017 - 2024<br>This applies to the contents of my blog and other texts on this site only.<br><a href=/terms-of-use>Terms of use</a><br><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Built with a <a href=https://github.com/va1entin/hugo-theme_clean-blog-custom target=_blank>custom version</a> of the <a href=https://github.com/StartBootstrap/startbootstrap-clean-blog/ target=_blank>Clean Blog theme</a> by <a href=https://startbootstrap.com target=_blank>StartBootstrap</a></div></ul><br><br></div></div></div></footer><script src=/js/bootstrap.bundle.min.js></script><script src=/js/scripts.js></script></body></html>